---
phase: 04-cloudflare-images
type: execute
---

<objective>
Configure Cloudflare Images for the photo gallery and upload sample photos.

Purpose: Establish the image hosting foundation for the photo gallery feature. Output: Working
Cloudflare Images integration with sample photos uploaded. </objective>

<execution_context> ~/.claude/get-shit-done/workflows/execute-phase.md ./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cloudflare-images/DISCOVERY.md
@.planning/codebase/STACK.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/INTEGRATIONS.md
@src/content/config.ts
@package.json

# Tech stack available:

- Astro 5.1.3 with content collections
- Zod for schema validation
- Node.js 22.12.0
- pnpm package manager

# Established patterns:

- Content collections in src/content/ with Zod schemas
- Collections defined in src/content/config.ts
- TypeScript for all source code
- camelCase function names, kebab-case for files

# Constraining decisions:

- Use Cloudflare Images for image hosting (v1.1 scope decision)
- Scripted API upload preferred over manual dashboard
- Content collection for metadata (matches posts/notes patterns)
- Direct Cloudflare URLs for serving

# From DISCOVERY.md:

- Max file size: 10 MB per image
- Upload via POST to /accounts/{account_id}/images/v1
- API token required with Account > Images > Edit permission
- Images served via https://imagedelivery.net/{account}/{image}/{variant} </context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <decision>Cloudflare API authentication method</decision>
  <context>Need to authenticate with Cloudflare Images API to upload photos. Two options with different tradeoffs.</context>
  <options>
    <option id="env-var">
      <name>Environment variable (CLOUDFLARE_API_TOKEN)</name>
      <pros>Secure, follows 12-factor app patterns, no hardcoded secrets</pros>
      <cons>Requires .env setup, not checked into git</cons>
    </option>
    <option id="wrangler">
      <name>wrangler CLI (authenticated)</name>
      <pros>Already installed (in package.json), reuses existing auth</pros>
      <cons>Requires wrangler login first, may need dashboard action</cons>
    </option>
  </options>
  <resume-signal>Select: env-var or wrangler</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Create photos content collection schema</name>
  <files>src/content/config.ts</files>
  <action>Add a new 'photos' collection to defineCollection in src/content/config.ts:
- Schema fields: id (string, Cloudflare image ID), title (string), description (optional string), collection (string, album name), tags (optional string array), date (date, uploadedAt), width (optional number), height (optional number), draft (boolean, default false)
- Follow existing pattern: use z.object(), z.string(), z.boolean().default()
- Add 'photos' to collections export
- Use kebab-case for collection directory reference later
This establishes the data structure for photo metadata, matching the existing posts/notes pattern.</action>
  <verify>pnpm astro check passes without errors, new 'photos' collection in exports</verify>
  <done>Photos collection defined with Zod schema, type-safe for photo entries</done>
</task>

<task type="auto">
  <name>Task 2: Create Cloudflare Images upload script</name>
  <files>scripts/upload-photos.js</files>
  <action>Create Node.js script at scripts/upload-photos.js:
- Accept CLOUDFLARE_ACCOUNT_ID and CLOUDFLARE_API_TOKEN from environment variables
- Accept directory path as argument (default: scripts/sample-photos/)
- For each image in directory: POST multipart/form-data to https://api.cloudflare.com/client/v4/accounts/{account_id}/images/v1
- Parse response to extract image ID, upload URL
- Generate .mdx file in src/content/photos/ with frontmatter containing id, title, date, etc.
- Use fetch API (built-in to Node 18+) or axios-lite
- Handle errors gracefully with try/catch
- Log progress for each upload
Script will be run with: node scripts/upload-photos.js path/to/photos</action>
  <verify>script exists, has proper error handling, references correct API endpoint</verify>
  <done>Upload script ready to push images to Cloudflare and generate content files</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Upload sample photos to Cloudflare Images</action>
  <instructions>
    The upload script has been created. Before running:
    1. Create a Cloudflare API token at https://dash.cloudflare.com/profile/api-tokens
       - Permissions: Account > Images > Edit
    2. Set environment variables:
       export CLOUDFLARE_ACCOUNT_ID=your_account_id
       export CLOUDFLARE_API_TOKEN=your_token
    3. Place sample photos in scripts/sample-photos/ directory
    4. Run: node scripts/upload-photos.js scripts/sample-photos/
  </instructions>
  <verification>src/content/photos/ directory contains .mdx files with Cloudflare image IDs in frontmatter</verification>
  <resume-signal>Type "done" when photos are uploaded</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create photos directory and index page</name>
  <files>src/pages/photos.astro</files>
  <action>Create src/pages/photos.astro (gallery index page):
- Import getCollection from 'astro:content'
- Fetch all photos where draft !== true
- Display basic photo grid (placeholder for Phase 6 masonry layout)
- Use Cloudflare Images URL format: https://imagedelivery.net/{account_id}/{image_id}/public
- Get account_id from environment variable or config
- Keep it simple - just verify images load, full gallery in Phase 6
- Follow existing page patterns in src/pages/ for layout consistency</action>
  <verify>pnpm astro build succeeds, photos page builds without errors</verify>
  <done>Photos index page created, displays uploaded photos from Cloudflare Images</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Cloudflare Images integration with photos page</what-built>
  <how-to-verify>
    1. Run: pnpm dev
    2. Visit: http://localhost:4321/photos
    3. Verify: Sample photos load from Cloudflare Images CDN
    4. Check: No console errors related to images
    5. Confirm: Image dimensions look correct
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Photos content collection schema defined in config.ts
- [ ] Upload script created and tested
- [ ] At least 3 sample photos uploaded to Cloudflare Images
- [ ] src/content/photos/ contains generated .mdx files
- [ ] /photos page loads and displays images
- [ ] pnpm astro build succeeds
- [ ] No TypeScript errors
</verification>

<success_criteria>

- Cloudflare Images API integration working
- Photos can be uploaded via script
- Photo metadata stored in content collection
- Photos display on /photos page from Cloudflare CDN
- Ready for Phase 5 (gallery data structure) </success_criteria>

<output>
After completion, create `.planning/phases/04-cloudflare-images/04-01-SUMMARY.md`:

# Phase 4 Plan 1: Cloudflare Images Setup Summary

**Cloudflare Images configured with photo upload workflow and sample gallery page.**

## Accomplishments

- Photos content collection schema added to config.ts
- Cloudflare Images upload script created
- Sample photos uploaded to Cloudflare
- Photos index page created at /photos

## Files Created/Modified

- `src/content/config.ts` - Added photos collection
- `scripts/upload-photos.js` - Upload script
- `src/pages/photos.astro` - Photos index page
- `src/content/photos/*.mdx` - Generated photo entries

## Decisions Made

- Authentication method: [env-var or wrangler]
- Content collection pattern confirmed
- Direct Cloudflare URL serving

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Cloudflare Images API working
- Photo metadata structure defined
- Ready for Phase 5: Gallery data structure enhancements
