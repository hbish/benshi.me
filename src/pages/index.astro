---
import Container from '../layouts/Container.astro'
import { getCollection, type CollectionEntry } from 'astro:content'

const twoYearsAgo = new Date()
twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2)

const posts = (await getCollection('posts'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .filter(p => !p.data.draft)
  .filter(p => p.data.date >= twoYearsAgo)
const postsByYear = new Map<number, CollectionEntry<'posts'>[]>()
posts.forEach(p => {
  const fullYear = p.data.date.getFullYear()
  if (postsByYear.get(fullYear)) {
    postsByYear.set(fullYear, postsByYear.get(fullYear)!.concat(p))
  } else {
    postsByYear.set(fullYear, [p])
  }
})
---

<Container title="Ben Shi - Software Engineer & Technologist">
  <div class="section-title text-center text-2xl my-2 px-4 sm:px-0">Posts</div>
  <section class="text-center px-4 sm:px-0">
    {
      posts.length === 0 ? (
        <div class="text-center my-8">
          <div class="text-lg mb-4">ðŸŒµ</div>
          <p class="text-theme-muted mb-2">Oops! I haven't written anything recently.</p>
          <p class="text-theme-muted mb-4">I'm probably busy coding or exploring new ideas!</p>
        </div>
      ) : (
        Array.from(postsByYear).map(([year, yearPosts]) => {
          return yearPosts.map((p, index) => {
            return (
              <div>
                {index === 0 && <h3 class="text-xl my-6">{year}</h3>}
                <div class={'row my-2'}>
                  <div class={'column'}>
                    <a href={`/${p.slug}/`}>{p.data.title}</a>
                    ::{' '}
                    <strong>
                      {p.data.date.toLocaleDateString(undefined, { month: 'long', day: 'numeric' })}
                    </strong>
                  </div>
                  <div>
                    {p.data.minutesRead && (
                      <span class={'time-to-read'}>~{p.data.minutesRead} min read</span>
                    )}
                  </div>
                </div>
              </div>
            )
          })
        })
      )
    }
    <div class="text-sm mt-8 flex flex-col gap-2">
      <a href="/archive/" class="text-blue-600 hover:text-blue-800 underline"> View all posts â†’ </a>
      <a href="/notes/" class="text-blue-600 hover:text-blue-800 underline">
        View my scribbles â†’
      </a>
    </div>
  </section>
</Container>
