---
import Container from '../layouts/Container.astro'
import { getCollection, type CollectionEntry } from 'astro:content'

const twoYearsAgo = new Date()
twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2)

const posts = (await getCollection('posts'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .filter(p => !p.data.draft)
  .filter(p => p.data.date < twoYearsAgo)

const postsByYear = new Map<number, CollectionEntry<'posts'>[]>()
posts.forEach(p => {
  const fullYear = p.data.date.getFullYear()
  if (postsByYear.get(fullYear)) {
    postsByYear.set(fullYear, postsByYear.get(fullYear)!.concat(p))
  } else {
    postsByYear.set(fullYear, [p])
  }
})
---

<Container title="Archive - Ben Shi">
  <div class="section-title text-center text-2xl my-2 px-4 sm:px-0">Archive</div>
  <div class="text-center mb-4 px-4 sm:px-0">
    <p class="text-gray-600">Posts older than 2 years</p>
  </div>
  <section class="text-center px-4 sm:px-0">
    {
      Array.from(postsByYear).map(([year, yearPosts]) => {
        return yearPosts.map((p, index) => {
          return (
            <div>
              {index === 0 && <h3 class="text-xl my-6">{year}</h3>}
              <div class={'row my-2'}>
                <div class={'column'}>
                  <a href={`/${p.slug}`}>{p.data.title}</a>
                  ::{' '}
                  <strong>
                    {p.data.date.toLocaleDateString(undefined, { month: 'long', day: 'numeric' })}
                  </strong>
                </div>
                <div>
                  {p.data.minutesRead && (
                    <span class={'time-to-read'}>~{p.data.minutesRead} min read</span>
                  )}
                </div>
              </div>
              {p.data.description && (
                <div class="post-excerpt text-left my-3 px-4">{p.data.description}</div>
              )}
            </div>
          )
        })
      })
    }
    {
      posts.length === 0 && (
        <div class="text-gray-500 text-center my-8">No archived posts found.</div>
      )
    }
  </section>
</Container>
