---
// ThemeToggle component for switching between theme variants
---

<div class="theme-toggle" data-theme-toggle>
  <label class="sr-only">Select theme</label>
  <select
    data-theme-selector
    class="theme-selector bg-theme border border-theme rounded px-2 py-1 text-sm text-theme-secondary focus:outline-none focus:ring-2 focus:ring-accent-theme"
  >
    <option value="light">light</option>
    <option value="dark">dark</option>
    <option value="gruv-light">gruv-light</option>
    <option value="gruv-dark">gruv-dark</option>
  </select>
</div>

<style>
  .theme-selector {
    font-family: inherit;
    font-size: 0.875rem;
    background-color: var(--color-bg);
    color: var(--color-text-secondary);
    border-color: var(--color-border);
    transition: all 0.2s ease;
  }

  .theme-selector:focus {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-color: var(--color-accent);
  }

  .theme-selector:hover {
    border-color: var(--color-accent);
  }

  .theme-selector option {
    background-color: var(--color-bg);
    color: var(--color-text);
  }
</style>

<script>
  // Theme management script
  const THEME_KEY = 'hbish-theme'
  const THEMES = ['light', 'dark', 'gruv-light', 'gruv-dark']
  const DEFAULT_THEME = 'light'

  function getSavedTheme(): string {
    if (typeof localStorage !== 'undefined') {
      const saved = localStorage.getItem(THEME_KEY)
      if (saved && THEMES.includes(saved)) {
        return saved
      }
    }

    // Fallback to system preference for light/dark
    if (typeof window !== 'undefined' && window.matchMedia) {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
    }

    return DEFAULT_THEME
  }

  function setTheme(theme: string) {
    if (!THEMES.includes(theme)) return

    const html = document.documentElement

    // Remove all theme classes
    THEMES.forEach(t => {
      html.classList.remove(t)
    })

    // Add the selected theme class
    html.classList.add(theme)

    // Save to localStorage
    if (typeof localStorage !== 'undefined') {
      localStorage.setItem(THEME_KEY, theme)
    }

    // Update all selectors
    document.querySelectorAll<HTMLSelectElement>('[data-theme-selector]').forEach(selector => {
      if (selector.value !== theme) {
        selector.value = theme
      }
    })
  }

  function initThemeToggle(container: HTMLElement) {
    const selector = container.querySelector<HTMLSelectElement>('[data-theme-selector]')
    if (!selector) return

    const savedTheme = getSavedTheme()
    selector.value = savedTheme

    selector.addEventListener('change', e => {
      const target = e.target as HTMLSelectElement
      setTheme(target.value)
    })
  }

  // Initialize all theme toggles
  function initAllThemeToggles() {
    document.querySelectorAll('[data-theme-toggle]').forEach(initThemeToggle)
    // Set initial theme
    setTheme(getSavedTheme())
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAllThemeToggles)
  } else {
    initAllThemeToggles()
  }

  // Handle page navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', initAllThemeToggles)
</script>
