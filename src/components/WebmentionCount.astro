---
import { Heart, MessageSquare } from '@lucide/astro'

export interface Props {
  target: string
}

const { target } = Astro.props
---

<div class="webmention-count" data-target={target}>
  <span class="interaction-stat">
    <Heart class="stat-icon" />
    <span class="count likes-count">0</span>
  </span>
  <span class="interaction-stat">
    <MessageSquare class="stat-icon" />
    <span class="count replies-count">0</span>
  </span>
</div>

<script>
  class WebmentionCount {
    constructor(element) {
      this.element = element
      this.target = element.dataset.target
      this.fetchCounts()
    }

    async fetchCounts() {
      if (!this.target) return

      try {
        const response = await fetch(
          `https://webmention.io/api/count?target=${encodeURIComponent(this.target)}`
        )
        const data = await response.json()

        const likesCount = (data.type?.like || 0) + (data.type?.repost || 0)
        const repliesCount = (data.type?.reply || 0) + (data.type?.mention || 0)
        const totalCount = likesCount + repliesCount

        this.updateCount('.likes-count', likesCount)
        this.updateCount('.replies-count', repliesCount)
        this.updateCount('.total-count', totalCount)

        // Show/hide stats based on counts
        this.toggleVisibility('.interaction-stat:first-child', likesCount > 0)
        this.toggleVisibility('.interaction-stat:nth-child(2)', repliesCount > 0)
        this.toggleVisibility('.interaction-stat:last-child', totalCount > 0)
      } catch {
        // Silently handle fetch errors for webmention counts
      }
    }

    updateCount(selector, count) {
      const element = this.element.querySelector(selector)
      if (element) {
        element.textContent = count.toString()
      }
    }

    toggleVisibility(selector, show) {
      const element = this.element.querySelector(selector)
      if (element) {
        element.style.display = show ? 'flex' : 'none'
      }
    }
  }

  // Initialize webmention counts
  document.addEventListener('DOMContentLoaded', () => {
    const elements = document.querySelectorAll('.webmention-count')
    elements.forEach(element => new WebmentionCount(element))
  })
</script>

<style>
  @reference "../styles/global.css";
  .webmention-count {
    @apply flex items-center gap-4 text-sm;
    color: var(--color-text-muted);
  }

  .interaction-stat {
    @apply flex items-center gap-1.5;
    display: none; /* Hidden by default, shown when counts > 0 */
  }

  .stat-icon {
    @apply w-4 h-4 flex-shrink-0;
  }

  .count {
    @apply font-medium;
  }

  /* Show total count when there are interactions */
  .webmention-count:not(:empty) .interaction-stat:last-child {
    /* Remove divider styling */
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .webmention-count {
      @apply gap-3 text-xs;
    }

    .stat-icon {
      @apply w-3.5 h-3.5;
    }
  }
</style>
